#!/bin/bash

# Detailed Search Scripts - Advanced movie search functionality

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
MOVIES_DIR="$SCRIPT_DIR/movies"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# API Key
get_api_key() {
    [ -n "$OMDB_API_KEY" ] && echo "$OMDB_API_KEY" && return 0
    [ -f "$HOME/.movie-database-api-key" ] && cat "$HOME/.movie-database-api-key" && return 0
    [ -f "$SCRIPT_DIR/omdb-config.sh" ] && source "$SCRIPT_DIR/omdb-config.sh" && [ -n "$OMDB_API_KEY" ] && echo "$OMDB_API_KEY"
}

api_search() {
    local query="$1"
    local api_key="$2"
    local search_url="http://www.omdbapi.com/?s=$(echo "$query" | sed 's/ /+/g')&type=movie&apikey=$api_key"
    curl -s "$search_url"
}

# Search by Director
search_by_director() {
    local director="$1"
    local api_key=$(get_api_key)

    if [ -z "$api_key" ]; then
        echo -e "\u001b[31m‚ùå No API key found\u001b[0m"
        return 1
    fi

    echo -e "\u001b[36müîé Finding films by ${director}...\u001b[0m"

    local result=$(api_search "\"${director}\"" "$api_key")

    if echo "$result" | jq -e '.Response == "True"' > /dev/null 2>&1; then
        local count=$(echo "$result" | jq '.Search | length')
        echo -e "\u001b[32m‚úì Found ${count} film(s)\u001b[0m"
        echo ""

        for i in $(seq 0 $((count - 1))); do
            local title=$(echo "$result" | jq -r ".Search[$i].Title")
            local year=$(echo "$result" | jq -r ".Search[$i].Year")
            local rating=$(echo "$result" | jq -r ".Search[$i].imdbRating // 'N/A'")
            local imdb_id=$(echo "$result" | jq -r ".Search[$i].imdbID")
            local type=$(echo "$result" | jq -r ".Search[$i].Type")

            echo -e "\u001b[0;37m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\u001b[0m"
            echo -e "\u001b[0;34müé¨ ${title} (${year})\u001b[0m"
            echo -e "\u001b[35m   Type: ${type} | Rating: ${rating}/10\u001b[0m"
            echo -e "\u001b[0;34m   IMDB: \u001b[0mhttps://www.imdb.com/title/${imdb_id}"
            echo ""
        done
    else
        echo -e "\u001b[31m‚ùå No results found for ${director}\u001b[0m"
    fi
}

# Search by Genre
search_by_genre() {
    local genre="$1"
    local api_key=$(get_api_key)

    if [ -z "$api_key" ]; then
        echo -e "\u001b[31m‚ùå No API key found\u001b[0m"
        return 1
    fi

    echo -e "\u001b[36müé≠ Finding ${genre} films...\u001b[0m"

    local result=$(api_search "\"${genre}\"" "$api_key")

    if echo "$result" | jq -e '.Response == "True"' > /dev/null 2>&1; then
        local count=$(echo "$result" | jq '.Search | length')
        echo -e "\u001b[32m‚úì Found ${count} film(s)\u001b[0m"
        echo ""

        for i in $(seq 0 $((count - 1))); do
            local title=$(echo "$result" | jq -r ".Search[$i].Title")
            local year=$(echo "$result" | jq -r ".Search[$i].Year")
            local rating=$(echo "$result" | jq -r ".Search[$i].imdbRating // 'N/A'")
            local imdb_id=$(echo "$result" | jq -r ".Search[$i].imdbID")

            echo -e "\u001b[0;37müé¨ ${title} (${year}) - ${rating}/10\u001b[0m"
            echo -e "\u001b[0;34m   ${imdb_id}: https://www.imdb.com/title/${imdb_id}\u001b[0m"
            echo ""
        done
    else
        echo -e "\u001b[31m‚ùå No results found for ${genre}\u001b[0m"
    fi
}

# Search by Year Range
search_by_year() {
    local start_year="$1"
    local end_year="$2"
    local api_key=$(get_api_key)

    if [ -z "$api_key" ]; then
        echo -e "\u001b[31m‚ùå No API key found\u001b[0m"
        return 1
    fi

    echo -e "\u001b[36müìÖ Finding films ${start_year}-${end_year}...\u001b[0m"

    local search_url="http://www.omdbapi.com/?type=movie&y=${start_year},${end_year}&apikey=$api_key"
    local result=$(curl -s "$search_url")

    if echo "$result" | jq -e '.Response == "True"' > /dev/null 2>&1; then
        local count=$(echo "$result" | jq '.Search | length')
        echo -e "\u001b[32m‚úì Found ${count} film(s)\u001b[0m"
        echo ""

        for i in $(seq 0 $((count - 1))); do
            local title=$(echo "$result" | jq -r ".Search[$i].Title")
            local year=$(echo "$result" | jq -r ".Search[$i].Year")
            local rating=$(echo "$result" | jq -r ".Search[$i].imdbRating // 'N/A'")
            local imdb_id=$(echo "$result" | jq -r ".Search[$i].imdbID")

            echo -e "\u001b[0;37müé¨ ${title} (${year}) - ${rating}/10\u001b[0m"
            echo -e "\u001b[0;34m   ${imdb_id}: https://www.imdb.com/title/${imdb_id}\u001b[0m"
            echo ""
        done
    else
        echo -e "\u001b[31m‚ùå No results found for ${start_year}-${end_year}\u001b[0m"
    fi
}

# Search by Rating
search_by_rating() {
    local min_rating="$1"
    local api_key=$(get_api_key)

    if [ -z "$api_key" ]; then
        echo -e "\u001b[31m‚ùå No API key found\u001b[0m"
        return 1
    fi

    echo -e "\u001b[36m‚≠ê Finding films with ${min_rating}+ rating...\u001b[0m"

    local search_url="http://www.omdbapi.com/?type=movie&apikey=$api_key"
    local result=$(curl -s "$search_url")

    if echo "$result" | jq -e '.Response == "True"' > /dev/null 2>&1; then
        local count=$(echo "$result" | jq '.Search | length')
        echo -e "\u001b[32m‚úì Found ${count} film(s)\u001b[0m"
        echo ""

        local matches=0
        for i in $(seq 0 $((count - 1))); do
            local rating=$(echo "$result" | jq -r ".Search[$i].imdbRating")
            if [ -n "$rating" ] && (( $(echo "$rating >= $min_rating" | bc -l) )); then
                local title=$(echo "$result" | jq -r ".Search[$i].Title")
                local year=$(echo "$result" | jq -r ".Search[$i].Year")
                local imdb_id=$(echo "$result" | jq -r ".Search[$i].imdbID")

                echo -e "\u001b[0;37müé¨ ${title} (${year}) - ${rating}/10\u001b[0m"
                echo -e "\u001b[0;34m   ${imdb_id}: https://www.imdb.com/title/${imdb_id}\u001b[0m"
                echo ""

                matches=$((matches + 1))

                # Stop after 20 matches to save API calls
                [ $matches -ge 20 ] && break
            fi
        done

        if [ $matches -eq 0 ]; then
            echo -e "\u001b[31m‚ùå No films found with ${min_rating}+ rating\u001b[0m"
        else
            echo -e "\u001b[32m‚úì Showing ${matches} of ${count} matching films\u001b[0m"
        fi
    else
        echo -e "\u001b[31m‚ùå No results found\u001b[0m"
    fi
}

# Combined search with filters
advanced_search() {
    local query="$1"
    local director="$2"
    local genre="$3"
    local year="$4"
    local rating="$5"

    local api_key=$(get_api_key)

    if [ -z "$api_key" ]; then
        echo -e "\u001b[31m‚ùå No API key found\u001b[0m"
        return 1
    fi

    echo -e "\u001b[36müîç Advanced search: ${query}${director:+, Director: ${director}}${genre:+, Genre: ${genre}}${year:+, Year: ${year}}${rating:+, Rating: ${rating}+}\u001b[0m"

    local search_url="http://www.omdbapi.com/?type=movie&apikey=$api_key"
    local result=$(curl -s "$search_url")

    if echo "$result" | jq -e '.Response == "True"' > /dev/null 2>&1; then
        local count=$(echo "$result" | jq '.Search | length')
        echo -e "\u001b[32m‚úì Found ${count} film(s)\u001b[0m"
        echo ""

        local matches=0
        for i in $(seq 0 $((count - 1))); do
            local title=$(echo "$result" | jq -r ".Search[$i].Title")
            local year=$(echo "$result" | jq -r ".Search[$i].Year")
            local rating=$(echo "$result" | jq -r ".Search[$i].imdbRating")
            local imdb_id=$(echo "$result" | jq -r ".Search[$i].imdbID")

            # Apply filters
            local match=true

            if [ -n "$director" ] && ! echo "$title" | grep -qi "$director"; then
                match=false
            fi

            if [ -n "$genre" ] && ! echo "$title" | grep -qi "$genre"; then
                match=false
            fi

            if [ -n "$year" ] && ! echo "$year" | grep -q "$year"; then
                match=false
            fi

            if [ -n "$rating" ] && [ "$rating" != "all" ] && [ -n "$rating" ] && ! (( $(echo "$rating >= $rating" | bc -l 2>/dev/null || echo "0") )); then
                if [ -n "$rating" ] && ! (( $(echo "$rating >= $rating" | bc -l) )); then
                    match=false
                fi
            fi

            if $match; then
                echo -e "\u001b[0;37müé¨ ${title} (${year}) - ${rating}/10\u001b[0m"
                echo -e "\u001b[0;34m   ${imdb_id}: https://www.imdb.com/title/${imdb_id}\u001b[0m"
                echo ""

                matches=$((matches + 1))

                # Stop after 10 matches
                [ $matches -ge 10 ] && break
            fi
        done

        if [ $matches -eq 0 ]; then
            echo -e "\u001b[31m‚ùå No films matched all filters\u001b[0m"
        else
            echo -e "\u001b[32m‚úì Showing ${matches} matching films\u001b[0m"
        fi
    else
        echo -e "\u001b[31m‚ùå No results found\u001b[0m"
    fi
}

# Show usage
show_usage() {
    echo -e "\u001b[36mDetailed Search Scripts\u001b[0m"
    echo ""
    echo "Usage: movie-search <command> [options]"
    echo ""
    echo "Commands:"
    echo "  director <name>            Search by director"
    echo "  genre <name>               Search by genre"
    echo "  year <start> <end>         Search by year range"
    echo "  rating <min>               Search by minimum rating"
    echo "  advanced <query> [director] [genre] [year] [rating]"
    echo "  test                        Test API connection"
    echo "  help                        Show this help"
    echo ""
    echo "Examples:"
    echo "  movie-search director \"Wes Anderson\""
    echo "  movie-search genre \"drama\""
    echo "  movie-search year 2020 2024"
    echo "  movie-search rating 8"
    echo "  movie-search advanced \"science fiction\" \"Christopher Nolan\" \"2020 2024\" \"8\""
}

# Test API
test_api() {
    local api_key=$(get_api_key)

    if [ -z "$api_key" ]; then
        echo -e "\u001b[31m‚ùå No API key found\u001b[0m"
        echo ""
        echo "Get a free key at: https://www.omdbapi.com/apikey.aspx"
        return 1
    fi

    echo -e "\u001b[36mTesting API connection...\u001b[0m"

    # Test search
    echo -e "\u001b[0;37m  Searching for \"Wes Anderson\"...\u001b[0m"
    local result=$(api_search "\"Wes Anderson\"" "$api_key")

    if echo "$result" | jq -e '.Response == "True"' > /dev/null 2>&1; then
        local count=$(echo "$result" | jq '.Search | length')
        echo -e "\u001b[32m  ‚úì API is working! Found ${count} film(s)\u001b[0m"

        local first_title=$(echo "$result" | jq -r '.Search[0].Title')
        echo -e "\u001b[0;37m  First result: ${first_title}\u001b[0m"
    else
        echo -e "\u001b[31m  ‚úó API test failed\u001b[0m"
        return 1
    fi

    echo ""
    echo -e "\u001b[32m‚úì API is working correctly\u001b[0m"
}

# Main
case "${1:-}" in
    director)
        search_by_director "$2"
        ;;
    genre)
        search_by_genre "$2"
        ;;
    year)
        search_by_year "$2" "$3"
        ;;
    rating)
        search_by_rating "$2"
        ;;
    advanced)
        advanced_search "$2" "$3" "$4" "$5" "$6"
        ;;
    test)
        test_api
        ;;
    help|--help|-h)
        show_usage
        ;;
    *)
        show_usage
        ;;
esac